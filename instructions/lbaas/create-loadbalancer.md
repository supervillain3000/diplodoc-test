---
title: Создание loadbalancer
description: Описание создания loadbalancer
---

# Создание loadbalancer

Балансировщик нагрузки - Load Balancer as a Service (LBaaS), распределяет входящий сетевой трафик между несколькими серверами или экземплярами виртуальных машин для обеспечения высокой доступности и надежности приложений. LBaaS предоставляет возможность масштабирования приложений, улучшения производительности и обеспечения отказоустойчивости.

## Доступные алгоритмы балансировки:

---

| Алгоритм          | Описание                                                                                                                                        |
| ----------------- | :---------------------------------------------------------------------------------------------------------------------------------------------- |
| Round Robin       | Последовательно отправляет запросы к каждому серверу по очереди.                                                                                |
| Least Connections | Отправляет запросы к серверу с наименьшим количеством активных соединений.                                                                      |
| Source IP Hash    | Назначает запросы на основе хеша IP-адреса клиента, чтобы запросы от одного и того же IP-адреса всегда направлялись к одному и тому же серверу. |

## Панель управления

---

1. Перейдите в [панель управления](https://auth.ps.kz/?required_keys=uid&redirect_uri=https://console.ps.kz/account) PS Cloud и в блоке **Ресурсы облака** нажмите на **создать** в ресурсе **количество балансировщиков**.

2. Заполните поля:

Где:

- `Название` - Название балансировщика
- `Тип` - небходимо отметить `lb.flavor_1`
- `Настройки сети` -
  - нажмите на добавить и укажите в какой подсети будет Ваш балансировщик
    параметры для создания подсети описаны в [инструкции](/)
  - Выберете плавающий IP адрес _использовать_
- `Правила` - можно добавить правила позднее при помощи инструкции [добавить правила](/) либо нажать _добавить_ и указать следующие параметры:
  - `имя` - имя для правила
  - `протокол балансировки` - выберете нужный протокол, по которому будет выполняться балансировка
  - `создать целевую группу` - также можно создать [целевую группу](/) и [проверку доступности](/) указав в этом пункте да и заполнив параметры. Посмотреть что означает каждый параметр Вы можете из следующих инструкций: [целевая группа](/) и [проверка доступности](/)

## Openstack CLI

---

1.  Выполните [установку](/ru/compute/instructions/compute-nova/instance-management) и пройдите [аутентификацию](ru/compute/instructions/compute-nova/instance-management) в проекте.
2.  Также дополнительно необходимо установить компонент OCtavia:
    `pip3 install python-octaviaclient`
3.  **Создайте балансировщик** при помощи следующей команды:

```
openstack loadbalancer create \
  --vip-subnet-id <ID_подсети> \
  --vip-address <IP_адрес> \
  --flavor <ID_флейвора> \
  --name <имя_балансировщика>
```

Где:

- `ID_подсети` - ID подсети, в которой будет размещен виртуальный IP-адрес (VIP) балансировщика нагрузки. VIP используется для приема входящего трафика. (Может использоваться [внтуренняя подсеть](/) с последующей привязкой [плавающего IP адреса](/))
- `IP_адрес` - Задает IP-адрес, который будет использоваться в качестве виртуального IP-адреса для балансировщика нагрузки. Этот адрес должен быть в пределах указанной подсети. Например для подсети `192.168.0.0/24` можно указать `192.168.0.19`, также с этим IP адресом _не должно_ быть созданных портов. (опционально - если не указать то будет выдан рандомный свободный IP)
- `ID_флейвора` - ID доступного флейвора для балансировщика, посмотреть можно при помощи команды: `openstack loadbalancer flavor list`
- `имя_балансировщика` - задайте имя для Вашего балансировщика

4. Проверьте, что балансировщик создался корректно:

   `openstack loadbalancer show <имя_балансировщика>`

5. Создайте слушателя (правило для балансировщика).
   Здесь будет создан новый обработчик, который будет принимать входящий трафик на указанном порту и передавать его в пул серверов для распределения.

```
openstack loadbalancer listener create \
  --name <listener_name> \
  --protocol <protocol> \
  --protocol-port <protocol_port> \
  <loadbalancer>
```

Где:

- `name` - задайте название для слушателя. В консоле управления оно будет отображено во вкладке _обработчик_.
- `protocol` - указывает протокол, который будет использоваться для слушателя. Возможные значения: {TCP,HTTP,HTTPS,TERMINATED_HTTPS,UDP,SCTP,PROMETHEUS}
- `protocol_port` - Указывает порт, на котором слушатель будет принимать входящий трафик. Например, порт `80` для HTTP или `443` для HTTPS.
- `loadbalancer` - название или ID балансировщика, который был создан ранее.

6. **Создайте новый пул для балансировщика**.
   Пул представляет собой группу серверов, к которым балансировщик нагрузки будет распределять трафик.

```
openstack loadbalancer pool create \
  --name <pool_name> \
  --lb-algorithm <algorithm> \
  --listener <listener_name> \
  --protocol <protocol_name>
```

Где:

- `pool_name` - задайте название для пула. В консоле управления оно будет отображено во вкладке _целевая группа_.
- `algorithm` - укажите алгоритм балансировки нагрузки. Доступные параметры:
  `{SOURCE_IP,ROUND_ROBIN,LEAST_CONNECTIONS,SOURCE_IP_PORT}`
- `listener_name` - укажите имя или ID _обработчика_, который был создан в предыдущем пункте.
  - `protocol_name` - Укажите протокол, который будет использоваться для передачи трафика в пуле. Например, `HTTP`

7. Добавьте сервера в **пул балансировщика**:

```
openstack loadbalancer member create \
  --subnet-id <ID_подсети> \
  --address <server_ip_address> \
  --protocol-port <protocol_port> \
  <pool_name>
```

Где:

- `ID_подсети` - ID подсети, к которой принадлежит добавляемый сервер.
- `server_ip_address` - IP-адрес сервера, который добавляется в _пул_.
- `protocol_port` - порт, на котором сервер будет принимать трафик, например _80_
- `pool_name` - имя или ID **пула**, который был создан в предыдущем пункте.

8. Укажите параметр проверки доступности:

```
openstack loadbalancer healthmonitor create \
--delay <delay> \
--max-retries <max_retries> \
--timeout <timeout> \
--type <protocol_name> \
<pool_name>
```

`delay` - Указывает интервал в секундах между проверками состояния членов пула.
`max_retries` - Указывает максимальное количество неудачных проверок, после которых член пула считается неработоспособным.
`timeout` - Указывает максимальное время в секундах, которое монитор будет ожидать ответа от члена пула.
`protocol_name` - Укажите протокол, который будет использоваться для проверки состояния. Например, `HTTP`.
`pool_name `- Указывает имя или ID пула, к которому привязан монитор состояния.

9.  Подключите [плавающий IP](Плавающий_IP) адрес к балансировщику, чтобы он был доступен извне:

```
openstack floating ip set --port <ID_балансировщика> <плавающий IP>
```

### Terraform

> [! note] - Внимание!  
> При создании балансировщика с помощью Terraform в блоке, в котором описываются параметры подключения к OpenStack, необходимо указать параметр `use_octavia = true`

Если у вас еще нет Terraform, [установите его и настройте провайдер Openstack](https://github.com/supervillain3000/docs/blob/master/ru/compute/instructions/compute)

1. Для создания балансировщика нагрузки можно использовать следующий блок:

```
resource "openstack_lb_loadbalancer_v2" "lb1-https-test" {

name = "lb1-https-test"

vip_subnet_id = "id_подсети"

}
```

Где:

- `name` - Устанавливает имя для балансировщика нагрузки.
- `vip_subnet_id` - Указывает ID подсети (subnet) в [виртуальной сети](/), в которой будет располагаться виртуальный IP-адрес балансировщика нагрузки. Посмотреть ID можно при помощи команды `openstack network list`

2. Для добавления правила добавьте следующий блок:

```
resource "openstack_lb_listener_v2" "listen-http-test" {
    name = "listen-https-test"
    description = "what to listen?"
    protocol = "HTTP"
    protocol_port = 80
    connection_limit = -1
    loadbalancer_id = openstack_lb_loadbalancer_v2.lb1-https-test.id
}
```

Где:

- `name` - Устанавливает имя для правила.
- `description` - описание слушателя (опционально).
- `protocol` - Указывает протокол, который слушатель будет использовать для обработки входящих соединений.
- `protocol_port` - Указывает порт, на котором слушатель будет принимать входящие соединения.
- `connection_limit` - Указывает максимальное количество соединений, которые слушатель может принимать одновременно. Значение `-1` означает, что ограничение на количество соединений отсутствует (неограниченное количество соединений).
- `loadbalancer_id` - Указывает идентификатор балансировщика нагрузки, к которому привязывается данное правило.

3. Для добавления пула добавьте следующий блок:

```
resource "openstack_lb_pool_v2" "http-pool-test" {
    name = "https-pool-test"
    protocol = "HTTP"
    lb_method = "ROUND_ROBIN"
    listener_id = openstack_lb_listener_v2.listen-https-test.id
}
```

Где:

- `name` - Устанавливает имя для пула серверов.
- `protocol` - Указывает протокол, который будет использоваться для связи с бэкэнд-серверами в пуле.
- `lb_method` - Указывает метод балансировки нагрузки, который будет использоваться для распределения трафика между серверами в пуле.
- `listener_id` - Указывает идентификатор слушателя (правила), который будет использовать этот пул серверов.

4. Для добавления мониторинга для проверки состояния бэкэнд-серверов в пуле используйте следующий блок:

```
resource "openstack_lb_monitor_v2" "https-monitor-test" {
    name = "https-monitor-test"
    delay = 5
    max_retries = 3
    timeout = 5
    type = "HTTP"
    url_path = "/"
    http_method = "GET"
    expected_codes = "200"
    pool_id = openstack_lb_pool_v2.https-pool-test.id
}
```

Где:

- `name` - Устанавливает имя для монитора
- `delay` - Указывает задержку в секундах между проверками состояния сервера.
- `max_retries` - Указывает максимальное количество неудачных попыток проверки, после которых сервер считается недоступным.
- `timeout` - Указывает время ожидания ответа от сервера в секундах.
- `type` - Указывает тип проверки состояния.
- `url_path` - Указывает путь URL для HTTP-проверки.
- `http_method` - Монитор будет использовать HTTP GET-запросы для проверки состояния серверов.
- `expected_codes` - Монитор будет ожидать HTTP статус 200 для успешной проверки.
- `pool_id` - ID пула, с которым будет связан Монитор

5. Для добавления сервера в пул используйте слудующий блок:

```
resource "openstack_lb_member_v2" "centos-lb2-https-test" {
    name = "centos-lb2-https-test"
    address = "192.168.0.223"
    protocol_port = 80
    pool_id = openstack_lb_pool_v2.https-pool-test.id
}
```

Где:

- `name` - Устанавливает имя для члена пула.
- `address` - Указывает IP-адрес члена пула.
- `protocol_port` - Указывает порт, на котором член пула принимает входящие соединения.
- `pool_id` - Указывает идентификатор пула серверов, к которому добавляется этот член.
